name: Create Release Package

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up environment
        run: |
          # Extraer versiÃ³n del tag
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building release for version: $VERSION"
      
      - name: Create release package
        run: |
          # Crear directorio para el paquete
          mkdir -p "bintools-${VERSION}"
          
          # Copiar archivos principales
          cp packages.sh "bintools-${VERSION}/"
          cp micursor.py "bintools-${VERSION}/"
          cp pymanager.sh "bintools-${VERSION}/"
          cp fix_hdmi_audio.sh "bintools-${VERSION}/"
          cp videoset.sh "bintools-${VERSION}/"
          cp nextcloud-installer.sh "bintools-${VERSION}/"
          cp hexroute "bintools-${VERSION}/"
          
          # Copiar directorio de configuraciones
          cp -r configs "bintools-${VERSION}/"
          
          # Crear archivo de versiÃ³n
          echo "${VERSION}" > "bintools-${VERSION}/VERSION"
          
          # Crear archivo de informaciÃ³n del release
          cat > "bintools-${VERSION}/RELEASE_INFO" << EOF
          bintools ${VERSION}
          Released: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Repository: https://github.com/maurorosero/bintools
          Install: curl -fsSL https://raw.githubusercontent.com/maurorosero/bintools/main/install.sh | bash -s -- --version ${VERSION}
          EOF
          
          # Crear paquete tar.gz
          tar -czf "bintools-${VERSION}.tar.gz" "bintools-${VERSION}/"
          
          # Mostrar contenido del paquete
          echo "Package contents:"
          tar -tzf "bintools-${VERSION}.tar.gz"
          
          # Mostrar tamaÃ±o del paquete
          echo "Package size: $(du -h bintools-${VERSION}.tar.gz | cut -f1)"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            bintools-${VERSION}.tar.gz
          body: |
            ## bintools ${VERSION}
            
            ### Installation
            ```bash
            # Install this specific version
            curl -fsSL https://raw.githubusercontent.com/maurorosero/bintools/main/install.sh | bash -s -- --version ${VERSION}
            
            # Install latest version
            curl -fsSL https://raw.githubusercontent.com/maurorosero/bintools/main/install.sh | bash
            ```
            
            ### What's included
            - ðŸ“¦ **packages.sh**: Multiplatform package installer
            - ðŸŽ¯ **micursor.py**: Cursor IDE manager
            - ðŸ **pymanager.sh**: Python environment manager
            - ðŸ”§ **fix_hdmi_audio.sh**: HDMI audio fixer
            - ðŸ–¥ï¸ **videoset.sh**: Display configuration
            - â˜ï¸ **nextcloud-installer.sh**: Nextcloud backup manager
            - ðŸŒ **hexroute**: Network route converter
            - âš™ï¸ **configs/**: Package configuration files
            
            ### Package Contents
            ```
            bintools-${VERSION}/
            â”œâ”€â”€ packages.sh
            â”œâ”€â”€ micursor.py
            â”œâ”€â”€ pymanager.sh
            â”œâ”€â”€ fix_hdmi_audio.sh
            â”œâ”€â”€ videoset.sh
            â”œâ”€â”€ nextcloud-installer.sh
            â”œâ”€â”€ hexroute
            â”œâ”€â”€ configs/
            â”‚   â”œâ”€â”€ base.pkg
            â”‚   â”œâ”€â”€ devs.pkg
            â”‚   â”œâ”€â”€ orgs.pkg
            â”‚   â””â”€â”€ user.pkg
            â”œâ”€â”€ VERSION
            â””â”€â”€ RELEASE_INFO
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest symlink
        run: |
          # Crear un symlink simbÃ³lico para 'latest'
          ln -sf "bintools-${VERSION}.tar.gz" "bintools-latest.tar.gz"
          
          # Subir el symlink como asset adicional
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @bintools-latest.tar.gz \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}/assets?name=bintools-latest.tar.gz"
